let productData = []; // 初期値は空
let refillList = [];
let html5QrCode;

async function loadProductData() {
    try {
        const response = await fetch('product-data.json'); // JSON ファイルを取得
        if (!response.ok) {
            throw new Error(`HTTPエラー: ${response.status}`);
        }
        productData = await response.json(); // データを JavaScript オブジェクトに変換
        console.log('商品データをロードしました:', productData);
    } catch (error) {
        console.error('商品データのロードに失敗しました:', error);
    }
}

function startScanning(mode) {
    const statusElement = document.getElementById('status');
    statusElement.textContent = 'スキャン進行中...';
    statusElement.className = 'scanning';

    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
        { facingMode: "environment" },
        {
            fps: 10,
            qrbox: { width: 250, height: 250 }
        },
        (decodedText) => {
            if (mode === 'sales') {
                handleSalesScan(decodedText);
            } else if (mode === 'warehouse') {
                handleWarehouseScan(decodedText);
            }
            stopScanning();
        },
        (errorMessage) => {
            console.error(errorMessage);
        }
    ).catch(err => {
        statusElement.textContent = `エラー: ${err}`;
        statusElement.className = 'error';
    });
}

function stopScanning() {
    if (html5QrCode) {
        html5QrCode.stop().then(() => {
            document.getElementById('status').textContent = 'スキャン停止';
            document.getElementById('status').className = '';
        }).catch(err => {
            document.getElementById('status').textContent = `スキャン停止エラー: ${err}`;
            document.getElementById('status').className = 'error';
        });
    }
}

function handleSalesScan(decodedText) {
    const statusElement = document.getElementById('status');
    const product = productData.find(item => item.barCode === decodedText);

    if (product) {
        const existingItem = refillList.find(item => item.code === product.barCode);

        if (!existingItem) {
            refillList.push({ code: product.barCode, name: product.name, status: '要補充' });
            updateRefillList();
            statusElement.textContent = `バーコード ${decodedText} (${product.name}) を「要補充」リストに追加しました。`;
            statusElement.className = 'success';
        } else {
            statusElement.textContent = `バーコード ${decodedText} (${product.name}) はすでにリストに存在します。`;
            statusElement.className = 'success';
        }
    } else {
        statusElement.textContent = `商品コード ${decodedText} が見つかりません。`;
        statusElement.className = 'error';
    }
}

function updateRefillList() {
    const listElement = document.getElementById('salesRefillList');
    listElement.innerHTML = '';

    refillList.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.code} - ${item.name} - ${item.status}`;
        listElement.appendChild(li);
    });
}

// ページロード時に JSON をロード
document.addEventListener('DOMContentLoaded', loadProductData);
